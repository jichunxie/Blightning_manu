---
title: "COVID_plots"
output: html_document
date: "2024-03-03"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#library(rhdf5)
library(Matrix)
library(Seurat)
library(ggplot2)
library(dplyr)
source("data/getscore.R")


```
#74-year-old Patient

### CD8 only
###CD8 effector
```{r}
covid_74_cd8_so = readRDS("data/covid_74_cd8_so.rds")

ret_effectorcd8 = readRDS("data/NEW_effectorcd8_BLightning_results_CFS1_cutoff3.rds")

cscore = 'CFS1'
nown.effector.upregulated.markers = c("GZMB","PRF1","IFNG","TNF","IL2RA","TBX21")
known.effector.downregulated.markers = c("CCR7","SELL")
```
```{r}

effectorscore0 = getscore(cscore,known.effector.upregulated.markers,known.effector.downregulated.markers,
                        covid_74_cd8_so@assays$RNA@counts[c(known.effector.upregulated.markers,known.effector.downregulated.markers),])

effectorscore1 = getscore(cscore,ret_effectorcd8[[2]],ret_effectorcd8[[3]],
                        covid_74_cd8_so@assays$RNA@counts[c(ret_effectorcd8[[2]],ret_effectorcd8[[3]]),])

effectorscore2 = getscore(cscore,c(known.effector.upregulated.markers,ret_effectorcd8[[2]]),c(known.effector.downregulated.markers,ret_effectorcd8[[3]]),
                        covid_74_cd8_so@assays$RNA@counts[c(known.effector.upregulated.markers,ret_effectorcd8[[2]],known.effector.downregulated.markers,ret_effectorcd8[[3]]),])

cd8_df = as.data.frame(effectorscore0)
cd8_df$effectorscore1 = effectorscore1
cd8_df$effectorscore2 = effectorscore2


cd8_metadata = covid_74_cd8_so@meta.data
cd8_metadata = cd8_metadata[rownames(cd8_df),]
cd8_df$days_post_intubation=cd8_metadata$days_post_intubation
cd8_df$days_post_intubation = paste("Day",cd8_df$days_post_intubation)
```

```{r CD8 from 74-year-old Patient Supplementary Fig 3c}

cd8_df$cellname = rownames(cd8_df)
cd8_df_selected = cd8_df %>%
  group_by(days_post_intubation) %>%
  filter(effectorscore2 > 0.675)

vln_df = data.frame(PDCD1 = covid_74_cd8_so[["RNA"]]@counts["PDCD1",cd8_df_selected$cellname], cluster = cd8_df_selected$days_post_intubation,TIM3 = covid_74_cd8_so[["RNA"]]@counts["HAVCR2",cd8_df_selected$cellname],
                    LAG3 = covid_74_cd8_so[["RNA"]]@counts["LAG3",cd8_df_selected$cellname],
                    ENTPD1 = covid_74_cd8_so[["RNA"]]@counts["ENTPD1",cd8_df_selected$cellname],
                    CTLA4 = covid_74_cd8_so[["RNA"]]@counts["CTLA4",cd8_df_selected$cellname])
VlnPlot(covid_74_cd8_so[,cd8_df_selected$cellname], features = "ENTPD1",group.by = "days_post_intubation",layer = 'counts' ) + theme_minimal() + ggtitle("") + theme(plot.title = element_text(size = 24, face = "bold")) + labs(x = "Days Post Intubation",fill = "") + 
  theme(axis.text.x = element_text(hjust=1,size = 24),
        axis.text.y = element_text(hjust=1,size = 24),
        axis.title.y = element_text(size = 30,face = "bold"),
        axis.title.x = element_text(size = 30,face = "bold"),
        legend.title = element_text(size=24,face = "bold"), #change legend title font size
        legend.text = element_text(size=24,face = "bold")) + theme(strip.text.x = element_text(size = 36,face = 'bold'))  + scale_fill_manual(values = rep("#69b3a2",7)) + NoLegend()

jpeg("CD8effector_PD1_bydays.jpeg",width=30,height=20,units="cm",res=300)
ggplot(vln_df, aes(x = cluster, y = PDCD1)) + geom_violin(aes(fill = cluster), trim=TRUE, scale = "width",colour = "#4f845c") + theme_minimal() + ggtitle("") + theme(plot.title = element_text(size = 24, face = "bold")) + labs(x = "Days Post Intubation",fill = "") + 
  theme(axis.text.x = element_text(hjust=1,size = 30,angle = 45),
        axis.text.y = element_text(hjust=1,size = 30),
        axis.title.y = element_text(size = 36,face = "bold"),
        axis.title.x = element_text(size = 36,face = "bold"),
        legend.title = element_text(size=24,face = "bold"), #change legend title font size
        legend.text = element_text(size=24,face = "bold")) + theme(strip.text.x = element_text(size = 36,face = 'bold'))  + scale_fill_manual(values = rep("#9fba95",7)) + NoLegend() 
dev.off()

jpeg("CD8effector_TM3_bydays.jpeg",width=30,height=20,units="cm",res=300)
ggplot(vln_df, aes(x = cluster, y = TIM3)) + geom_violin(aes(fill = cluster), trim=TRUE, scale = "width",,colour = "#4f845c") + theme_minimal() + ggtitle("") + theme(plot.title = element_text(size = 24, face = "bold")) + labs(x = "Days Post Intubation",fill = "") + 
  theme(axis.text.x = element_text(hjust=1,size = 30,angle = 45),
        axis.text.y = element_text(hjust=1,size = 30),
        axis.title.y = element_text(size = 36,face = "bold"),
        axis.title.x = element_text(size = 36,face = "bold"),
        legend.title = element_text(size=24,face = "bold"), #change legend title font size
        legend.text = element_text(size=24,face = "bold")) + theme(strip.text.x = element_text(size = 36,face = 'bold'))  + scale_fill_manual(values = rep("#9fba95",7)) + NoLegend() 
dev.off()

jpeg("CD8effector_CTLA4_bydays.jpeg",width=30,height=20,units="cm",res=300)
ggplot(vln_df, aes(x = cluster, y = CTLA4)) + geom_violin(aes(fill = cluster), trim=TRUE, scale = "width",,colour = "#4f845c") + theme_minimal() + ggtitle("") + theme(plot.title = element_text(size = 24, face = "bold")) + labs(x = "Days Post Intubation",fill = "") + 
  theme(axis.text.x = element_text(hjust=1,size = 30,angle = 45),
        axis.text.y = element_text(hjust=1,size = 30),
        axis.title.y = element_text(size = 36,face = "bold"),
        axis.title.x = element_text(size = 36,face = "bold"),
        legend.title = element_text(size=24,face = "bold"), #change legend title font size
        legend.text = element_text(size=24,face = "bold")) + theme(strip.text.x = element_text(size = 36,face = 'bold'))  + scale_fill_manual(values = rep("#9fba95",7)) + NoLegend() 
dev.off()

jpeg("CD8effector_LAG3_bydays.jpeg",width=30,height=20,units="cm",res=300)
ggplot(vln_df, aes(x = cluster, y = LAG3)) + geom_violin(aes(fill = cluster), trim=TRUE, scale = "width",,colour = "#4f845c") + theme_minimal() + ggtitle("") + theme(plot.title = element_text(size = 24, face = "bold")) + labs(x = "Days Post Intubation",fill = "") + 
  theme(axis.text.x = element_text(hjust=1,size = 30,angle = 45),
        axis.text.y = element_text(hjust=1,size = 30),
        axis.title.y = element_text(size = 36,face = "bold"),
        axis.title.x = element_text(size = 36,face = "bold"),
        legend.title = element_text(size=24,face = "bold"), #change legend title font size
        legend.text = element_text(size=24,face = "bold")) + theme(strip.text.x = element_text(size = 36,face = 'bold'))  + scale_fill_manual(values = rep("#9fba95",7)) + NoLegend() 
dev.off()

jpeg("CD8effector_ENTPD1_bydays.jpeg",width=30,height=20,units="cm",res=300)
ggplot(vln_df, aes(x = cluster, y = ENTPD1)) + geom_violin(aes(fill = cluster), trim=TRUE, scale = "width",,colour = "#4f845c") + theme_minimal() + ggtitle("") + theme(plot.title = element_text(size = 24, face = "bold")) + labs(x = "Days Post Intubation",fill = "") + 
  theme(axis.text.x = element_text(hjust=1,size = 30,angle = 45),
        axis.text.y = element_text(hjust=1,size = 30),
        axis.title.y = element_text(size = 36,face = "bold"),
        axis.title.x = element_text(size = 36,face = "bold"),
        legend.title = element_text(size=24,face = "bold"), #change legend title font size
        legend.text = element_text(size=24,face = "bold")) + theme(strip.text.x = element_text(size = 36,face = 'bold'))  + scale_fill_manual(values = rep("#9fba95",7)) + NoLegend() 
dev.off()
```
```{r CD8 from 74-year-old Patient Supplementary Fig 3b, 5d}
cd8_dummy <- cd8_df %>%
  group_by(days_post_intubation) %>%
  summarize(effectorscore0.mean = median(effectorscore0),effectorscore1.mean = median(effectorscore1),effectorscore2.mean = median(effectorscore2))

cd8_df$group = cd8_df$effectorscore1 >0.675

jpeg("CD8_effectorscore0_bydays.jpeg",width=150,height=25,units="cm",res=300)
ggplot(data = cd8_df, aes(x=effectorscore0))  +labs(x = "",y = "Density") +
 # geom_density(lwd = 2.5, linetype = "dashed",aes(x = effectorscore0),colour = c("#575757") )+ 
  geom_density(lwd = 5, linetype = 1,aes(x=effectorscore0),colour = c("#2A9D8C"))+ 
  facet_wrap( ~ days_post_intubation,nrow = 1) + 
  geom_vline(data=cd8_dummy, aes(xintercept=effectorscore0.mean),colour = c("#2A9D8C"),lwd = 5, linetype = 1) +
  theme_linedraw() + ggtitle("CD8 Effector CFS") + theme(plot.title = element_text(size = 58, face = "bold")) + 
  theme(axis.text.x = element_text(hjust=1,size = 36,face = "bold"),
        axis.text.y = element_text(hjust=1,size = 42,face = "bold"),
        axis.title.y = element_text(size = 46,face = "bold"),
        legend.title = element_text(size=46,face = "bold"), #change legend title font size
        legend.text = element_text(size=46,face = "bold")) + theme(strip.text.x = element_text(size = 52,face = 'bold')) +
  theme(strip.background =element_rect(fill="white"))+
  theme(strip.text = element_text(colour = 'black')) + xlim(0,0.8)
dev.off()

jpeg("CD8_effectorscore2_bydays.jpeg",width=150,height=25,units="cm",res=300)
ggplot(data = cd8_df, aes(x=effectorscore2))  +labs(x = "",y = "Density") +
 # geom_density(lwd = 2.5, linetype = "dashed",aes(x = effectorscore0),colour = c("#575757") )+ 
  geom_density(lwd = 5, linetype = 1,aes(x=effectorscore2),colour = c("#2A9D8C"))+ 
  facet_wrap( ~ days_post_intubation,nrow = 1) + 
  geom_vline(data=cd8_dummy, aes(xintercept=effectorscore2.mean),colour = c("#2A9D8C"),lwd = 5, linetype = 1) +
  theme_linedraw() + ggtitle("CD8 Effector CFS") + theme(plot.title = element_text(size = 58, face = "bold")) + 
  theme(axis.text.x = element_text(hjust=1,size = 36,face = "bold"),
        axis.text.y = element_text(hjust=1,size = 42,face = "bold"),
        axis.title.y = element_text(size = 46,face = "bold"),
        legend.title = element_text(size=46,face = "bold"), #change legend title font size
        legend.text = element_text(size=46,face = "bold")) + theme(strip.text.x = element_text(size = 52,face = 'bold')) + geom_segment(aes(x = 0.675, y = 0, xend = 0.675, yend = 7),color = "#f16c23",lwd = 5,linetype = "dashed") + 
  theme(strip.background =element_rect(fill="white"))+
  theme(strip.text = element_text(colour = 'black')) + ylim(0,7)
dev.off()
```

### CD8 memory

```{r}
ret_memorycd8 = readRDS("data/NEW_memorycd8_BLightning_results_CFS1_cutoff4.rds")

known.memory.upregulated.markers = c("CD27","CD28","PTPRC","SELL","CCR7","BCL2","IL7R","CXCR3","EOMES","ID3")
known.memory.upregulated.markers = known.memory.upregulated.markers[known.memory.upregulated.markers %in% rownames(covid_74_cd8_so)]
known.memory.downregulated.markers = c()

```

```{r}

memoryscore0 = getscore(cscore,known.memory.upregulated.markers,known.memory.downregulated.markers,
                        covid_74_cd8_so@assays$RNA@counts[c(known.memory.upregulated.markers,known.memory.downregulated.markers),])

memoryscore1 = getscore(cscore,ret_memorycd8[[2]],ret_memorycd8[[3]],
                        covid_74_cd8_so@assays$RNA@counts[c(ret_memorycd8[[2]],ret_memorycd8[[3]]),])

memoryscore2 = getscore(cscore,c(known.memory.upregulated.markers,ret_memorycd8[[2]]),c(known.memory.downregulated.markers,ret_memorycd8[[3]]),
                        covid_74_cd8_so@assays$RNA@counts[c(known.memory.upregulated.markers,ret_memorycd8[[2]],known.memory.downregulated.markers,ret_memorycd8[[3]]),])

cd8_df$memoryscore0 = memoryscore0
cd8_df$memoryscore1 = memoryscore1
cd8_df$memoryscore2 = memoryscore2
```

```{r CD8 from 74-year-old Patient Supplementary Fig 3a, 5c}
cd8_dummy <- cd8_df %>%
  group_by(days_post_intubation) %>%
  summarize(memoryscore0.mean = median(memoryscore0),memoryscore1.mean = median(memoryscore1),memoryscore2.mean = median(memoryscore2))

jpeg("CD8_memoryscore0_bydays.jpeg",width=150,height=25,units="cm",res=300)
ggplot(data = cd8_df, aes(x = memoryscore0))  +labs(x = "",y = "Density") +
  geom_density(lwd = 5, linetype = 1,aes(x = memoryscore0),colour = c("#287271"))+ 
  facet_wrap( ~ days_post_intubation,nrow = 1) + 
  geom_vline(data = cd8_dummy, aes(xintercept = memoryscore0.mean),colour = c("#287271"),lwd = 5, linetype = 1) +
  theme_linedraw() + ggtitle("CD8 Memory CFS") + theme(plot.title = element_text(size = 58, face = "bold")) + 
  theme(axis.text.x = element_text(hjust=1,size = 36,face = "bold"),
        axis.text.y = element_text(hjust=1,size = 42,face = "bold"),
        axis.title.y = element_text(size = 46,face = "bold"),
        legend.title = element_text(size=46,face = "bold"), #change legend title font size
        legend.text = element_text(size=46,face = "bold")) + theme(strip.text.x = element_text(size = 52,face = 'bold')) +
  theme(strip.background =element_rect(fill="white"))+
  theme(strip.text = element_text(colour = 'black')) + xlim(0,0.8)
dev.off()

jpeg("CD8_memoryscore2_bydays.jpeg",width=150,height=25,units="cm",res=300)
ggplot(data = cd8_df, aes(x=memoryscore2))  +labs(x = "",y = "Density") +
  geom_density(lwd = 5, linetype = 1,aes(x=memoryscore2),colour = c("#287271"))+ 
  facet_wrap( ~ days_post_intubation,nrow = 1) + 
  geom_vline(data=cd8_dummy, aes(xintercept=memoryscore2.mean),colour = c("#287271"),lwd = 5, linetype = 1) +
  theme_linedraw() + ggtitle("CD8 Memory CFS") + theme(plot.title = element_text(size = 58, face = "bold")) + 
  theme(axis.text.x = element_text(hjust=1,size = 36,face = "bold"),
        axis.text.y = element_text(hjust=1,size = 42,face = "bold"),
        axis.title.y = element_text(size = 46,face = "bold"),
        legend.title = element_text(size=46,face = "bold"), #change legend title font size
        legend.text = element_text(size=46,face = "bold")) + theme(strip.text.x = element_text(size = 52,face = 'bold')) +  
  theme(strip.background =element_rect(fill="white"))+
  theme(strip.text = element_text(colour = 'black')) + ylim(0,7)
dev.off()

```

```{r CD8 from 74-year-old Patient Supplementary Fig 2}
cd8_df$UMAP1 = as.data.frame(covid_74_cd8_so@reductions$umap@cell.embeddings)$umap_1
cd8_df$UMAP2 = as.data.frame(covid_74_cd8_so@reductions$umap@cell.embeddings)$umap_2
cd8_df$PDCD1 = covid_74_cd8_so@assays$RNA@counts['PDCD1',] %>% as.vector()

cd8_df %>% ggplot() + geom_point(aes(x = UMAP1, y = UMAP2,colour = PDCD1, size = 3))

jpeg("CD8_UMAP.jpeg",width=30,height=25,units="cm",res=300)
cd8_df %>% ggplot() + geom_point(aes(x = UMAP1, y = UMAP2,colour = days_post_intubation), size = 3)+ scale_color_manual(values = c("#D55E00","#E69F00","#009E73","#56B4E9","#0072B2","#CC79A7","purple"),name = "Days Post Intubation") + theme_minimal() + 
  theme(axis.text.x = element_text(hjust=1,size = 22),
        axis.text.y = element_text(hjust=1,size = 22),
        axis.title.x = element_text(size = 28,face = "bold"),
        axis.title.y = element_text(size = 28,face = "bold"),
        legend.title = element_text(size=28,face = "bold"), #change legend title font size
        legend.text = element_text(size=28,face = 'bold')) 
dev.off()

jpeg("CD8_UMAP_coloredbyeffectorscore0.jpeg",width=30,height=25,units="cm",res=300)
cd8_df %>% arrange(effectorscore0) %>% ggplot() + geom_point(aes(x = UMAP1, y = UMAP2,colour = rank(effectorscore0)/dim(cd8_df)[1]),alpha = 7/10,size = 3)+ scale_colour_gradientn(limits=c(0, 1),breaks=seq(0,1,by=0.25),colours = colorRamps::blue2red(10),name = "Rank/N") + theme_minimal()+ 
  theme(axis.text.x = element_text(hjust=1,size = 22),
        axis.text.y = element_text(hjust=1,size = 22),
        axis.title.x = element_text(size = 28,face = "bold"),
        axis.title.y = element_text(size = 28,face = "bold"),
        legend.title = element_text(size=28,face = "bold"), #change legend title font size
        legend.text = element_text(size=28,face = "bold"))
dev.off()


jpeg("CD8_UMAP_coloredbyeffectorscore2.jpeg",width=30,height=25,units="cm",res=300)
cd8_df %>% arrange(effectorscore2) %>% ggplot() + geom_point(aes(x = UMAP1, y = UMAP2,colour = rank(effectorscore2)/dim(cd8_df)[1]),alpha = 7/10,size = 3)+ scale_colour_gradientn(limits=c(0, 1),breaks=seq(0,1,by=0.25),colours = colorRamps::blue2red(10),name = "Rank/N") + theme_minimal()+ 
  theme(axis.text.x = element_text(hjust=1,size = 22),
        axis.text.y = element_text(hjust=1,size = 22),
        axis.title.x = element_text(size = 28,face = "bold"),
        axis.title.y = element_text(size = 28,face = "bold"),
        legend.title = element_text(size=28,face = "bold"), #change legend title font size
        legend.text = element_text(size=28,face = "bold"))
dev.off()

jpeg("CD8_UMAP_coloredbymemoryscore0.jpeg",width=30,height=25,units="cm",res=300)
cd8_df %>% arrange(memoryscore0) %>% ggplot() + geom_point(aes(x = UMAP1, y = UMAP2,colour = rank(memoryscore0)/dim(cd8_df)[1]),alpha = 7/10,size = 3)+ scale_colour_gradientn(limits=c(0, 1),breaks=seq(0,1,by=0.25),colours = colorRamps::blue2red(10),name = "Rank/N") + theme_minimal()+ 
  theme(axis.text.x = element_text(hjust=1,size = 22),
        axis.text.y = element_text(hjust=1,size = 22),
        axis.title.x = element_text(size = 28,face = "bold"),
        axis.title.y = element_text(size = 28,face = "bold"),
        legend.title = element_text(size=28,face = "bold"), #change legend title font size
        legend.text = element_text(size=28,face = "bold"))
dev.off()



jpeg("CD8_UMAP_coloredbymemoryscore2.jpeg",width=30,height=25,units="cm",res=300)
cd8_df %>% arrange(memoryscore2) %>% ggplot() + geom_point(aes(x = UMAP1, y = UMAP2,colour = rank(memoryscore2)/dim(cd8_df)[1]),alpha = 7/10,size = 3)+ scale_colour_gradientn(limits=c(0, 1),breaks=seq(0,1,by=0.25),colours = colorRamps::blue2red(10),name = "Rank/N") + theme_minimal()+ 
 theme(axis.text.x = element_text(hjust=1,size = 22),
        axis.text.y = element_text(hjust=1,size = 22),
        axis.title.x = element_text(size = 28,face = "bold"),
        axis.title.y = element_text(size = 28,face = "bold"),
        legend.title = element_text(size=28,face = "bold"), #change legend title font size
        legend.text = element_text(size=28,face = "bold"))
dev.off()
```
```{r CD8 from 74-year-old Patient Supplementary Fig 3d-e}
library(ggpmisc)
library(ggpubr)
jpeg("CD8_memory0_vs_effector0.jpeg",width=150,height=25,units="cm",res=300)
ggplot(data = cd8_df, aes(x=memoryscore0,y = effectorscore0))+ 
  geom_point(colour = c("#287271"),size = 3)+  geom_smooth(method = "lm",colour = "#F3A261",fill = "#F3A261",size = 4) + xlim(0,0.9) +
  stat_cor(method = "pearson",cor.coef.name = "rho",size = 16,
            aes(label =paste0(..r.label..,' (', cut(..p..,
                                           breaks = c(-Inf,1e-6, 1e-4, 1e-2, Inf),
                                           labels = c("'***'", "'**'", "'*'", "'ns'")),')')) )+
  facet_wrap( ~ days_post_intubation,nrow = 1) + 
  scale_color_manual(values = c("#287271"), name = "Days Post Intubation") + xlab("CD8 Memory CFS") + ylab("CD8 Effector CFS") + 
  theme_linedraw() + theme(plot.title = element_text(size = 58, face = "bold")) + 
  theme(axis.text.x = element_text(hjust=1,size = 42),
        axis.text.y = element_text(hjust=1,size = 42),
        axis.title.x = element_text(size = 52,face = "bold"),
        axis.title.y = element_text(size = 52,face = "bold"),
        legend.title = element_text(size=28,face = "bold"), #change legend title font size
        legend.text = element_text(size=28,face = "bold")) + theme(strip.text.x = element_text(size = 52,face = 'bold')) + 
  theme(strip.background =element_rect(fill="white"))+
  theme(strip.text = element_text(colour = 'black'))  
dev.off()


jpeg("CD8_memory2_vs_effector2.jpeg",width=150,height=25,units="cm",res=300)
ggplot(data = cd8_df, aes(x=memoryscore2,y = effectorscore2))+ 
  geom_point(colour = c("#287271"),size = 3)+  geom_smooth(method = "lm",colour = "#F3A261",fill = "#F3A261",size = 4)  +
  stat_cor(method = "pearson",cor.coef.name = "rho",size = 16,
            aes(label =paste0(..r.label..,' (', cut(..p..,
                                           breaks = c(-Inf,1e-6, 1e-4, 1e-2, Inf),
                                           labels = c("'***'", "'**'", "'*'", "'ns'")),')')) ) +
  facet_wrap( ~ days_post_intubation,nrow = 1) + 
  scale_color_manual(values = c("#287271"), name = "Days Post Intubation") + xlab("CD8 Memory CFS") + ylab("CD8 Effector CFS") + 
  theme_linedraw() + theme(plot.title = element_text(size = 58, face = "bold")) + 
  theme(axis.text.x = element_text(hjust=1,size = 42),
        axis.text.y = element_text(hjust=1,size = 42),
        axis.title.x = element_text(size = 52,face = "bold"),
        axis.title.y = element_text(size = 52,face = "bold"),
        legend.title = element_text(size=28,face = "bold"), #change legend title font size
        legend.text = element_text(size=28,face = "bold")) + theme(strip.text.x = element_text(size = 52,face = 'bold')) + 
  theme(strip.background =element_rect(fill="white"))+
  theme(strip.text = element_text(colour = 'black')) + ylim(0,0.8)
dev.off()
```


### CD4 only

###CD4 effector
```{r}
covid_74_cd4_so = readRDS("data/covid_74_cd4_so.rds")
ret_effectorcd4 = readRDS("data/NEW_effectorcd4_BLightning_results_CFS1_cutoff3.rds")
known.effector.upregulated.markers =  c("IFNG","TBX21","GATA3","CXCR3","RORC","TNF")
known.effector.downregulated.markers = c()
```
```{r}

effectorscore0 = getscore(cscore,known.effector.upregulated.markers,known.effector.downregulated.markers,
                        covid_74_cd4_so@assays$RNA@counts[c(known.effector.upregulated.markers,known.effector.downregulated.markers),])

effectorscore1 = getscore(cscore,ret_effectorcd4[[2]],ret_effectorcd4[[3]],
                        covid_74_cd4_so@assays$RNA@counts[c(ret_effectorcd4[[2]],ret_effectorcd4[[3]]),])

effectorscore2 = getscore(cscore,c(known.effector.upregulated.markers,ret_effectorcd4[[2]]),c(known.effector.downregulated.markers,ret_effectorcd4[[3]]),
                        covid_74_cd4_so@assays$RNA@counts[c(known.effector.upregulated.markers,ret_effectorcd4[[2]],known.effector.downregulated.markers,ret_effectorcd4[[3]]),])

cd4_df = as.data.frame(effectorscore0)
cd4_df$effectorscore1 = effectorscore1
cd4_df$effectorscore2 = effectorscore2


cd4_metadata = covid_74_cd4_so@meta.data
cd4_metadata = cd4_metadata[rownames(cd4_df),]
cd4_df$days_post_intubation=cd4_metadata$days_post_intubation
cd4_df$days_post_intubation = paste("Day",cd4_df$days_post_intubation)

```

```{r CD4 from 74-year-old Patient Fig 4c}

cd4_df$cellname = rownames(cd4_df)
cd4_df_selected = cd4_df %>%
  group_by(days_post_intubation) %>%
  filter(effectorscore2 > 0.8)

vln_df = data.frame(PDCD1 = covid_74_cd4_so[["RNA"]]@counts["PDCD1",cd4_df_selected$cellname], cluster = cd4_df_selected$days_post_intubation,TIM3 = covid_74_cd4_so[["RNA"]]@counts["HAVCR2",cd4_df_selected$cellname],
                    LAG3 = covid_74_cd4_so[["RNA"]]@counts["LAG3",cd4_df_selected$cellname],
                    ENTPD1 = covid_74_cd4_so[["RNA"]]@counts["ENTPD1",cd4_df_selected$cellname],
                    CTLA4 = covid_74_cd4_so[["RNA"]]@counts["CTLA4",cd4_df_selected$cellname])


VlnPlot(covid_74_cd4_so[,cd8_df_selected$cellname], features = "ENTPD1",group.by = "days_post_intubation",layer = 'counts' ) + theme_minimal() + ggtitle("") + theme(plot.title = element_text(size = 24, face = "bold")) + labs(x = "Days Post Intubation",fill = "") + 
  theme(axis.text.x = element_text(hjust=1,size = 24),
        axis.text.y = element_text(hjust=1,size = 24),
        axis.title.y = element_text(size = 30,face = "bold"),
        axis.title.x = element_text(size = 30,face = "bold"),
        legend.title = element_text(size=24,face = "bold"), #change legend title font size
        legend.text = element_text(size=24,face = "bold")) + theme(strip.text.x = element_text(size = 36,face = 'bold'))  + scale_fill_manual(values = rep("#69b3a2",7)) + NoLegend()

jpeg("CD4effector_PD1_bydays.jpeg",width=30,height=20,units="cm",res=300)
ggplot(vln_df, aes(x = cluster, y = PDCD1)) + geom_violin(aes(fill = cluster), trim=TRUE, scale = "width",colour = "#4f845c") + theme_minimal() + ggtitle("") + theme(plot.title = element_text(size = 24, face = "bold")) + labs(x = "Days Post Intubation",fill = "") + 
  theme(axis.text.x = element_text(hjust=1,size = 30,angle = 45),
        axis.text.y = element_text(hjust=1,size = 30),
        axis.title.y = element_text(size = 36,face = "bold"),
        axis.title.x = element_text(size = 36,face = "bold"),
        legend.title = element_text(size=24,face = "bold"), #change legend title font size
        legend.text = element_text(size=24,face = "bold")) + theme(strip.text.x = element_text(size = 36,face = 'bold'))  + scale_fill_manual(values = rep("#9fba95",7)) + NoLegend() 
dev.off()

jpeg("CD4effector_TM3_bydays.jpeg",width=30,height=20,units="cm",res=300)
ggplot(vln_df, aes(x = cluster, y = TIM3)) + geom_violin(aes(fill = cluster), trim=TRUE, scale = "width",,colour = "#4f845c") + theme_minimal() + ggtitle("") + theme(plot.title = element_text(size = 24, face = "bold")) + labs(x = "Days Post Intubation",fill = "") + 
  theme(axis.text.x = element_text(hjust=1,size = 30,angle = 45),
        axis.text.y = element_text(hjust=1,size = 30),
        axis.title.y = element_text(size = 36,face = "bold"),
        axis.title.x = element_text(size = 36,face = "bold"),
        legend.title = element_text(size=24,face = "bold"), #change legend title font size
        legend.text = element_text(size=24,face = "bold")) + theme(strip.text.x = element_text(size = 36,face = 'bold'))  + scale_fill_manual(values = rep("#9fba95",7)) + NoLegend() 
dev.off()

jpeg("CD4effector_CTLA4_bydays.jpeg",width=30,height=20,units="cm",res=300)
ggplot(vln_df, aes(x = cluster, y = CTLA4)) + geom_violin(aes(fill = cluster), trim=TRUE, scale = "width",,colour = "#4f845c") + theme_minimal() + ggtitle("") + theme(plot.title = element_text(size = 24, face = "bold")) + labs(x = "Days Post Intubation",fill = "") + 
  theme(axis.text.x = element_text(hjust=1,size = 30,angle = 45),
        axis.text.y = element_text(hjust=1,size = 30),
        axis.title.y = element_text(size = 36,face = "bold"),
        axis.title.x = element_text(size = 36,face = "bold"),
        legend.title = element_text(size=24,face = "bold"), #change legend title font size
        legend.text = element_text(size=24,face = "bold")) + theme(strip.text.x = element_text(size = 36,face = 'bold'))  + scale_fill_manual(values = rep("#9fba95",7)) + NoLegend() 
dev.off()

jpeg("/CD4effector_LAG3_bydays.jpeg",width=30,height=20,units="cm",res=300)
ggplot(vln_df, aes(x = cluster, y = LAG3)) + geom_violin(aes(fill = cluster), trim=TRUE, scale = "width",,colour = "#4f845c") + theme_minimal() + ggtitle("") + theme(plot.title = element_text(size = 24, face = "bold")) + labs(x = "Days Post Intubation",fill = "") + 
  theme(axis.text.x = element_text(hjust=1,size = 30,angle = 45),
        axis.text.y = element_text(hjust=1,size = 30),
        axis.title.y = element_text(size = 36,face = "bold"),
        axis.title.x = element_text(size = 36,face = "bold"),
        legend.title = element_text(size=24,face = "bold"), #change legend title font size
        legend.text = element_text(size=24,face = "bold")) + theme(strip.text.x = element_text(size = 36,face = 'bold'))  + scale_fill_manual(values = rep("#9fba95",7)) + NoLegend() 
dev.off()

jpeg("CD4effector_ENTPD1_bydays.jpeg",width=30,height=20,units="cm",res=300)
ggplot(vln_df, aes(x = cluster, y = ENTPD1)) + geom_violin(aes(fill = cluster), trim=TRUE, scale = "width",,colour = "#4f845c") + theme_minimal() + ggtitle("") + theme(plot.title = element_text(size = 24, face = "bold")) + labs(x = "Days Post Intubation",fill = "") + 
  theme(axis.text.x = element_text(hjust=1,size = 30,angle = 45),
        axis.text.y = element_text(hjust=1,size = 30),
        axis.title.y = element_text(size = 36,face = "bold"),
        axis.title.x = element_text(size = 36,face = "bold"),
        legend.title = element_text(size=24,face = "bold"), #change legend title font size
        legend.text = element_text(size=24,face = "bold")) + theme(strip.text.x = element_text(size = 36,face = 'bold'))  + scale_fill_manual(values = rep("#9fba95",7)) + NoLegend() 
dev.off()
```

```{r CD4 from 74-year-old Patient Fig 4b; Supplementary Fig 5b}
cd4_dummy <- cd4_df %>%
  group_by(days_post_intubation) %>%
  summarize(effectorscore0.mean = median(effectorscore0),effectorscore1.mean = median(effectorscore1),effectorscore2.mean = median(effectorscore2))


jpeg("CD4_effectorscore0_bydays.jpeg",width=150,height=25,units="cm",res=300)
ggplot(data = cd4_df, aes(x=effectorscore0))  +labs(x = "",y = "Density") +
 # geom_density(lwd = 2.5, linetype = "dashed",aes(x = effectorscore0),colour = c("#575757") )+ 
  geom_density(lwd = 5, linetype = 1,aes(x=effectorscore0),colour = c("#2A9D8C"))+ 
  facet_wrap( ~ days_post_intubation,nrow = 1) + 
  geom_vline(data=cd4_dummy, aes(xintercept=effectorscore0.mean),colour = c("#2A9D8C"),lwd = 5, linetype = 1) +
  theme_linedraw() + ggtitle("CD4 Effector CFS") + theme(plot.title = element_text(size = 58, face = "bold")) + 
  theme(axis.text.x = element_text(hjust=1,size = 27,face = "bold"),
        axis.text.y = element_text(hjust=1,size = 42,face = "bold"),
        axis.title.y = element_text(size = 46,face = "bold"),
        legend.title = element_text(size=46,face = "bold"), #change legend title font size
        legend.text = element_text(size=46,face = "bold")) + theme(strip.text.x = element_text(size = 52,face = 'bold')) +
  theme(strip.background =element_rect(fill="white"))+
  theme(strip.text = element_text(colour = 'black')) +xlim(0,1)+ ylim(0,10)
dev.off()


jpeg("CD4_effectorscore2_bydays.jpeg",width=150,height=25,units="cm",res=300)
ggplot(data = cd4_df, aes(x=effectorscore2))  +labs(x = "",y = "Density") +
  geom_density(lwd = 5, linetype = 1,aes(x=effectorscore2),colour = c("#2A9D8C"))+ 
  facet_wrap( ~ days_post_intubation,nrow = 1) + 
  geom_vline(data=cd4_dummy, aes(xintercept=effectorscore2.mean),colour = c("#2A9D8C"),lwd = 5, linetype = 1) +
  theme_linedraw() + ggtitle("CD4 Effector CFS") + theme(plot.title = element_text(size = 58, face = "bold")) + 
  theme(axis.text.x = element_text(hjust=1,size = 30,face = "bold"),
        axis.text.y = element_text(hjust=1,size = 42,face = "bold"),
        axis.title.y = element_text(size = 46,face = "bold"),
        legend.title = element_text(size=46,face = "bold"), #change legend title font size
        legend.text = element_text(size=46,face = "bold")) + theme(strip.text.x = element_text(size = 52,face = 'bold')) + geom_segment(aes(x = 0.8, y = 0, xend = 0.8, yend = 7),color = "#f16c23",lwd = 5,linetype = "dashed") + 
  theme(strip.background =element_rect(fill="white"))+
  theme(strip.text = element_text(colour = 'black')) + ylim(0,7)
dev.off()
```


### cd4 memory

```{r}
ret_memorycd4 = readRDS("data/memorycd4_BLightning_results_CFS1_cutoff3.rds")

known.memory.upregulated.markers = c("PTPRC","SELL","CCR7","CD27","CD44")

known.memory.downregulated.markers = c()

```

```{r}
memoryscore0 = getscore(cscore,known.memory.upregulated.markers,known.memory.downregulated.markers,
                        covid_74_cd4_so@assays$RNA@counts[c(known.memory.upregulated.markers,known.memory.downregulated.markers),])

memoryscore1 = getscore(cscore,ret_memorycd4[[2]],ret_memorycd4[[3]],
                        covid_74_cd4_so@assays$RNA@counts[c(ret_memorycd4[[2]],ret_memorycd4[[3]]),])

memoryscore2 = getscore(cscore,c(known.memory.upregulated.markers,ret_memorycd4[[2]]),c(known.memory.downregulated.markers,ret_memorycd4[[3]]),
                        covid_74_cd4_so@assays$RNA@counts[c(known.memory.upregulated.markers,ret_memorycd4[[2]],known.memory.downregulated.markers,ret_memorycd4[[3]]),])

cd4_df$memoryscore0 = memoryscore0
cd4_df$memoryscore1 = memoryscore1
cd4_df$memoryscore2 = memoryscore2
```

```{r CD4 from 74-year-old Patient Fig 4a, Supplementary Fig 5a}
cd4_dummy <- cd4_df %>%
  group_by(days_post_intubation) %>%
  summarize(memoryscore0.mean = median(memoryscore0),memoryscore1.mean = median(memoryscore1),memoryscore2.mean = median(memoryscore2))


jpeg("CD4_memoryscore0_bydays.jpeg",width=150,height=25,units="cm",res=300)
ggplot(data = cd4_df, aes(x = memoryscore0))  +labs(x = "",y = "Density") +
 # geom_density(lwd = 2.5, linetype = "dashed",aes(x = effectorscore0),colour = c("#575757") )+ 
  geom_density(lwd = 5, linetype = 1,aes(x = memoryscore0),colour = c("#287271"))+ 
  facet_wrap( ~ days_post_intubation,nrow = 1) + 
  geom_vline(data = cd4_dummy, aes(xintercept = memoryscore0.mean),colour = c("#287271"),lwd = 5, linetype = 1) +
  theme_linedraw() + ggtitle("CD4 Memory CFS") + theme(plot.title = element_text(size = 58, face = "bold")) + 
  theme(axis.text.x = element_text(hjust=1,size = 24,face = "bold"),
        axis.text.y = element_text(hjust=1,size = 42,face = "bold"),
        axis.title.y = element_text(size = 46,face = "bold"),
        legend.title = element_text(size=46,face = "bold"), #change legend title font size
        legend.text = element_text(size=46,face = "bold")) + theme(strip.text.x = element_text(size = 52,face = 'bold')) +
  theme(strip.background =element_rect(fill="white"))+
  theme(strip.text = element_text(colour = 'black')) + ylim(0,10)
dev.off()

jpeg("CD4_memoryscore2_bydays.jpeg",width=150,height=25,units="cm",res=300)
ggplot(data = cd4_df, aes(x=memoryscore2))  +labs(x = "",y = "Density") +
  geom_density(lwd = 5, linetype = 1,aes(x=memoryscore2),colour = c("#287271"))+ 
  facet_wrap( ~ days_post_intubation,nrow = 1) + 
  geom_vline(data=cd4_dummy, aes(xintercept=memoryscore2.mean),colour = c("#287271"),lwd = 5, linetype = 1) +
  theme_linedraw() + ggtitle("CD4 Memory CFS") + theme(plot.title = element_text(size = 58, face = "bold")) + 
  theme(axis.text.x = element_text(hjust=1,size = 24,face = "bold"),
        axis.text.y = element_text(hjust=1,size = 42,face = "bold"),
        axis.title.y = element_text(size = 46,face = "bold"),
        legend.title = element_text(size=46,face = "bold"), #change legend title font size
        legend.text = element_text(size=46,face = "bold")) + theme(strip.text.x = element_text(size = 52,face = 'bold')) + 
  theme(strip.background =element_rect(fill="white"))+
  theme(strip.text = element_text(colour = 'black')) + ylim(0,7) + xlim(0,1.15)
dev.off()

```

```{r CD4 from 74-year-old Supplementary Fig 1}
cd4_df$UMAP1 = as.data.frame(covid_74_cd4_so@reductions$umap@cell.embeddings)$umap_1
cd4_df$UMAP2= as.data.frame(covid_74_cd4_so@reductions$umap@cell.embeddings)$umap_2

jpeg("CD4_UMAP.jpeg",width=36,height=25,units="cm",res=300)
cd4_df %>% ggplot() + geom_point(aes(x = UMAP1, y = UMAP2,colour = days_post_intubation), size = 3)+ scale_color_manual(values = c("#D55E00","#E69F00","#009E73","#56B4E9","#0072B2","#CC79A7","purple"),name = "Days Post Intubation") + theme_minimal() + 
  theme(axis.text.x = element_text(hjust=1,size = 22),
        axis.text.y = element_text(hjust=1,size = 22),
        axis.title.x = element_text(size = 28,face = "bold"),
        axis.title.y = element_text(size = 28,face = "bold"),
        legend.title = element_text(size=28,face = "bold"), #change legend title font size
        legend.text = element_text(size=28,face = "bold")) +guides(colour = guide_legend(override.aes = list(size=10)))
dev.off()

jpeg("CD4_UMAP_coloredbyeffectorscore0.jpeg",width=30,height=25,units="cm",res=300)
cd4_df %>% arrange(effectorscore0) %>% ggplot() + geom_point(aes(x = UMAP1, y = UMAP2,colour = rank(effectorscore0)/dim(cd4_df)[1]),alpha = 7/10,size = 3)+ scale_colour_gradientn(limits=c(0, 1),breaks=seq(0,1,by=0.25),colours = colorRamps::blue2red(10),name = "Rank/N") + theme_minimal()+ 
  theme_minimal() + 
  theme(axis.text.x = element_text(hjust=1,size = 22),
        axis.text.y = element_text(hjust=1,size = 22),
        axis.title.x = element_text(size = 28,face = "bold"),
        axis.title.y = element_text(size = 28,face = "bold"),
        legend.title = element_text(size=28,face = "bold"), #change legend title font size
        legend.text = element_text(size=28,face = "bold")) 
dev.off()


jpeg("CD4_UMAP_coloredbyeffectorscore2.jpeg",width=30,height=25,units="cm",res=300)
cd4_df %>% arrange(effectorscore2) %>% ggplot() + geom_point(aes(x = UMAP1, y = UMAP2,colour = rank(effectorscore2)/dim(cd4_df)[1]),alpha = 7/10,size = 3)+ scale_colour_gradientn(limits=c(0, 1),breaks=seq(0,1,by=0.25),colours = colorRamps::blue2red(10),name = "Rank/N") + theme_minimal()+ 
  theme_minimal() + 
  theme(axis.text.x = element_text(hjust=1,size = 22),
        axis.text.y = element_text(hjust=1,size = 22),
        axis.title.x = element_text(size = 28,face = "bold"),
        axis.title.y = element_text(size = 28,face = "bold"),
        legend.title = element_text(size=28,face = "bold"), #change legend title font size
        legend.text = element_text(size=28,face = "bold")) 
dev.off()


jpeg("CD4_UMAP_coloredbymemoryscore0.jpeg",width=30,height=25,units="cm",res=300)
cd4_df %>% arrange(memoryscore0) %>% ggplot() + geom_point(aes(x = UMAP1, y = UMAP2,colour = rank(memoryscore0 + effectorscore0)/dim(cd4_df)[1]),alpha = 7/10,size = 3)+ scale_colour_gradientn(limits=c(0, 1),breaks=seq(0,1,by=0.25),colours = colorRamps::blue2red(10),name = "Rank/N") + theme_minimal()+ 
  theme_minimal() + 
  theme(axis.text.x = element_text(hjust=1,size = 22),
        axis.text.y = element_text(hjust=1,size = 22),
        axis.title.x = element_text(size = 28,face = "bold"),
        axis.title.y = element_text(size = 28,face = "bold"),
        legend.title = element_text(size=28,face = "bold"), #change legend title font size
        legend.text = element_text(size=28,face = "bold")) 
dev.off()

jpeg("~/Misc/B-Lightning/COVID_longitudinal/CD4_UMAP_coloredbymemoryscore2.jpeg",width=30,height=25,units="cm",res=300)
cd4_df %>% arrange(memoryscore2) %>% ggplot() + geom_point(aes(x = UMAP1, y = UMAP2,colour = rank(memoryscore2)/dim(cd4_df)[1]),alpha = 7/10,size = 3)+ scale_colour_gradientn(limits=c(0, 1),breaks=seq(0,1,by=0.25),colours = colorRamps::blue2red(10),name = "Rank/N") + theme_minimal()+ 
  theme_minimal() + 
  theme(axis.text.x = element_text(hjust=1,size = 22),
        axis.text.y = element_text(hjust=1,size = 22),
        axis.title.x = element_text(size = 28,face = "bold"),
        axis.title.y = element_text(size = 28,face = "bold"),
        legend.title = element_text(size=28,face = "bold"), #change legend title font size
        legend.text = element_text(size=28,face = "bold")) 
dev.off()
```
```{r CD4 from 74-year-old Patient Fig 4d-e}
library(ggpmisc)
library(ggpubr)
jpeg("CD4_memory0_vs_effector0.jpeg",width=150,height=25,units="cm",res=300)
ggplot(data = cd4_df, aes(x=memoryscore0,y = effectorscore0))+ 
  geom_point(colour = c("#287271"),size = 3)+  geom_smooth(method = "lm",colour = "#F3A261",fill = "#F3A261",size = 4) + xlim(0,0.9) +
  stat_cor(method = "pearson",cor.coef.name = "rho",size = 16,
            aes(label =paste0(..r.label..,' (', cut(..p..,
                                           breaks = c(-Inf,1e-6, 1e-4, 1e-2, Inf),
                                           labels = c("'***'", "'**'", "'*'", "'ns'")),')')) )+
  facet_wrap( ~ days_post_intubation,nrow = 1) + 
  scale_color_manual(values = c("#287271"), name = "Days Post Intubation") + xlab("CD4 Memory CFS") + ylab("CD4 Effector CFS") + 
  theme_linedraw() + theme(plot.title = element_text(size = 58, face = "bold")) + 
  theme(axis.text.x = element_text(hjust=1,size = 42),
        axis.text.y = element_text(hjust=1,size = 42),
        axis.title.x = element_text(size = 52,face = "bold"),
        axis.title.y = element_text(size = 52,face = "bold"),
        legend.title = element_text(size=28,face = "bold"), #change legend title font size
        legend.text = element_text(size=28,face = "bold")) + theme(strip.text.x = element_text(size = 52,face = 'bold')) + 
  theme(strip.background =element_rect(fill="white"))+
  theme(strip.text = element_text(colour = 'black')) + xlim(0,0.8) + ylim(0,1.15)
dev.off()


jpeg("CD4_memory2_vs_effector2.jpeg",width=150,height=25,units="cm",res=300)
ggplot(data = cd4_df, aes(x=memoryscore2,y = effectorscore2))+ 
  geom_point(colour = c("#287271"),size = 3)+  geom_smooth(method = "lm",colour = "#F3A261",fill = "#F3A261",size = 4)  +
  stat_cor(method = "pearson",cor.coef.name = "rho",size = 16,
            aes(label =paste0(..r.label..,' (', cut(..p..,
                                           breaks = c(-Inf,1e-6, 1e-4, 1e-2, Inf),
                                           labels = c("'***'", "'**'", "'*'", "'ns'")),')')) )+
  facet_wrap( ~ days_post_intubation,nrow = 1) + 
  scale_color_manual(values = c("#287271"), name = "Days Post Intubation") + xlab("CD4 Memory CFS") + ylab("CD4 Effector CFS") + 
  theme_linedraw() + theme(plot.title = element_text(size = 58, face = "bold")) + 
  theme(axis.text.x = element_text(hjust=1,size = 42),
        axis.text.y = element_text(hjust=1,size = 42),
        axis.title.x = element_text(size = 52,face = "bold"),
        axis.title.y = element_text(size = 52,face = "bold"),
        legend.title = element_text(size=28,face = "bold"), #change legend title font size
        legend.text = element_text(size=28,face = "bold")) + theme(strip.text.x = element_text(size = 52,face = 'bold')) + 
  theme(strip.background =element_rect(fill="white"))+
  theme(strip.text = element_text(colour = 'black')) 
dev.off()


```

# 66-year-old Patient
```{r loading}
covid_66_cd8 = readRDS("data/covid_66_cd8_so.rds")
covid_66_cd4 = readRDS("data/covid_66_cd4_so.rds")
```
```{r CD8 from 66-year-old Patient Supplementary Fig 4a-b, 6c-d}

ret_effectorcd8 = readRDS("data/NEW_effectorcd8_BLightning_results_CFS1_cutoff3.rds")#3
cscore = 'CFS1'

known.effector.upregulated.markers = c("GZMB","PRF1","IFNG","TNF","IL2RA","TBX21")
known.effector.downregulated.markers = c("CCR7","SELL")

effectorscore0 = getscore(cscore,known.effector.upregulated.markers,known.effector.downregulated.markers,
                          covid_66_cd8@assays$RNA@counts[c(known.effector.upregulated.markers,known.effector.downregulated.markers),])

effectorscore1 = getscore(cscore,ret_effectorcd8[[2]],ret_effectorcd8[[3]],
                          covid_66_cd8@assays$RNA@counts[c(ret_effectorcd8[[2]],ret_effectorcd8[[3]]),])

effectorscore2 = getscore(cscore,c(known.effector.upregulated.markers,ret_effectorcd8[[2]]),c(known.effector.downregulated.markers,ret_effectorcd8[[3]]),
                          covid_66_cd8@assays$RNA@counts[c(known.effector.upregulated.markers,ret_effectorcd8[[2]],known.effector.downregulated.markers,ret_effectorcd8[[3]]),])

cd8_df = as.data.frame(effectorscore0)
cd8_df$effectorscore1 = effectorscore1
cd8_df$effectorscore2 = effectorscore2


cd8_metadata = covid_66_cd8@meta.data
cd8_metadata = cd8_metadata[rownames(cd8_df),]
cd8_df$days_post_intubation=cd8_metadata$days_post_intubation
cd8_df$days_post_intubation[cd8_df$days_post_intubation %in% c("3","4")] = "3,4"
cd8_df$days_post_intubation = paste("Day",cd8_df$days_post_intubation)

ret_memorycd8 = readRDS("NEW_memorycd8_BLightning_results_CFS1_cutoff4.rds")#4

known.memory.upregulated.markers = c("CD27","CD28","PTPRC","SELL","CCR7","BCL2","IL7R","CXCR3","EOMES","ID3")
known.memory.upregulated.markers = known.memory.upregulated.markers[known.memory.upregulated.markers %in% rownames(covid_66_cd8)]
known.memory.downregulated.markers = c()

memoryscore0 = getscore(cscore,known.memory.upregulated.markers,known.memory.downregulated.markers,
                        covid_66_cd8@assays$RNA@counts[c(known.memory.upregulated.markers,known.memory.downregulated.markers),])

memoryscore1 = getscore(cscore,ret_memorycd8[[2]],ret_memorycd8[[3]],
                        covid_66_cd8@assays$RNA@counts[c(ret_memorycd8[[2]],ret_memorycd8[[3]]),])

memoryscore2 = getscore(cscore,c(known.memory.upregulated.markers,ret_memorycd8[[2]]),c(known.memory.downregulated.markers,ret_memorycd8[[3]]),
                        covid_66_cd8@assays$RNA@counts[c(known.memory.upregulated.markers,ret_memorycd8[[2]],known.memory.downregulated.markers,ret_memorycd8[[3]]),])

cd8_df$memoryscore0 = memoryscore0
cd8_df$memoryscore1 = memoryscore1
cd8_df$memoryscore2 = memoryscore2

cd8_dummy <- cd8_df %>%
  group_by(days_post_intubation) %>%
  summarize(effectorscore0.mean = median(effectorscore0),effectorscore1.mean = median(effectorscore1),effectorscore2.mean = median(effectorscore2))

jpeg("66yrold_CD8_effectorscore0_bydays.jpeg",width=75,height=25,units="cm",res=300)
ggplot(data = cd8_df, aes(x=effectorscore0))  +labs(x = "",y = "Density") +
  geom_density(lwd = 5, linetype = 1,aes(x=effectorscore0),colour = c("#3290B5"))+ 
  facet_wrap( ~ days_post_intubation,nrow = 1) + 
  geom_vline(data=cd8_dummy, aes(xintercept=effectorscore0.mean),colour = c("#3290B5"),lwd = 5, linetype = 1) +
  theme_linedraw() + ggtitle("CD8 Effector CFS") + theme(plot.title = element_text(size = 58, face = "bold")) + 
  theme(axis.text.x = element_text(hjust=1,size = 36,face = "bold"),
        axis.text.y = element_text(hjust=1,size = 42,face = "bold"),
        axis.title.y = element_text(size = 46,face = "bold"),
        legend.title = element_text(size=46,face = "bold"), 
        legend.text = element_text(size=46,face = "bold")) + theme(strip.text.x = element_text(size = 52,face = 'bold')) +
  theme(strip.background =element_rect(fill="white"))+
  theme(strip.text = element_text(colour = 'black')) + ylim(0,4)
dev.off()


jpeg("66yrold_CD8_effectorscore2_bydays.jpeg",width=75,height=25,units="cm",res=300)
ggplot(data = cd8_df, aes(x=effectorscore2))  +labs(x = "",y = "Density") +
  geom_density(lwd = 5, linetype = 1,aes(x=effectorscore2),colour = c("#3290B5"))+ 
  facet_wrap( ~ days_post_intubation,nrow = 1) + 
  geom_vline(data=cd8_dummy, aes(xintercept=effectorscore2.mean),colour = c("#3290B5"),lwd = 5, linetype = 1) +
  theme_linedraw() + ggtitle("CD8 Effector CFS") + theme(plot.title = element_text(size = 58, face = "bold")) + 
  theme(axis.text.x = element_text(hjust=1,size = 36,face = "bold"),
        axis.text.y = element_text(hjust=1,size = 42,face = "bold"),
        axis.title.y = element_text(size = 46,face = "bold"),
        legend.title = element_text(size=46,face = "bold"), #change legend title font size
        legend.text = element_text(size=46,face = "bold")) + theme(strip.text.x = element_text(size = 52,face = 'bold')) + 
  theme(strip.background =element_rect(fill="white"))+
  theme(strip.text = element_text(colour = 'black')) + ylim(0,5) + xlim(0,0.8)
dev.off()


cd8_dummy <- cd8_df %>%
  group_by(days_post_intubation) %>%
  summarize(memoryscore0.mean = median(memoryscore0),memoryscore1.mean = median(memoryscore1),memoryscore2.mean = median(memoryscore2))

jpeg("66yrold_CD8_memoryscore0_bydays.jpeg",width=75,height=25,units="cm",res=300)
ggplot(data = cd8_df, aes(x = memoryscore0))  +labs(x = "",y = "Density") +
  geom_density(lwd = 5, linetype = 1,aes(x = memoryscore0),colour = c("#03608C"))+ 
  facet_wrap( ~ days_post_intubation,nrow = 1) + 
  geom_vline(data = cd8_dummy, aes(xintercept = memoryscore0.mean),colour = c("#03608C"),lwd = 5, linetype = 1) +
  theme_linedraw() + ggtitle("CD8 Memory CFS") + theme(plot.title = element_text(size = 58, face = "bold")) + 
  theme(axis.text.x = element_text(hjust=1,size = 36,face = "bold"),
        axis.text.y = element_text(hjust=1,size = 42,face = "bold"),
        axis.title.y = element_text(size = 46,face = "bold"),
        legend.title = element_text(size=46,face = "bold"), #change legend title font size
        legend.text = element_text(size=46,face = "bold")) + theme(strip.text.x = element_text(size = 52,face = 'bold')) +
  theme(strip.background =element_rect(fill="white"))+
  theme(strip.text = element_text(colour = 'black')) + ylim(0,4)
dev.off()


jpeg("66yrold_CD8_memoryscore2_bydays.jpeg",width=75,height=25,units="cm",res=300)
ggplot(data = cd8_df, aes(x=memoryscore2))  +labs(x = "",y = "Density") +
  geom_density(lwd = 5, linetype = 1,aes(x=memoryscore2),colour = c("#03608C"))+ 
  facet_wrap( ~ days_post_intubation,nrow = 1) + 
  geom_vline(data=cd8_dummy, aes(xintercept=memoryscore2.mean),colour = c("#03608C"),lwd = 5, linetype = 1) +
  theme_linedraw() + ggtitle("CD8 Memory CFS") + theme(plot.title = element_text(size = 58, face = "bold")) + 
  theme(axis.text.x = element_text(hjust=1,size = 36,face = "bold"),
        axis.text.y = element_text(hjust=1,size = 42,face = "bold"),
        axis.title.y = element_text(size = 46,face = "bold"),
        legend.title = element_text(size=46,face = "bold"), #change legend title font size
        legend.text = element_text(size=46,face = "bold")) + theme(strip.text.x = element_text(size = 52,face = 'bold')) + 
  theme(strip.background =element_rect(fill="white"))+
  theme(strip.text = element_text(colour = 'black')) + ylim(0,5)
dev.off()
```
```{r CD8 from 66-year-old Patient Supplementary Fig 4c-d}

library(ggpubr)
jpeg("66yrold_CD8_memory0_vs_effector0.jpeg",width=75,height=25,units="cm",res=300)
ggplot(data = cd8_df, aes(x=memoryscore0,y = effectorscore0))+ 
  geom_point(colour = c("#f1bc1a"),size = 4)+  geom_smooth(method = "lm",colour = "#cd6116",fill = "#cd6116",size = 4) + 
  stat_cor(method = "pearson",cor.coef.name = "rho",size = 16,
            aes(label =paste0(..r.label..,' (', cut(..p..,
                                           breaks = c(-Inf,1e-6, 1e-4, 1e-2, Inf),
                                           labels = c("'***'", "'**'", "'*'", "'ns'")),')')) )+
  facet_wrap( ~ days_post_intubation,nrow = 1) + 
  scale_color_manual(values = c("#f1bc1a"), name = "Days Post Intubation") + xlab("CD8 Memory CFS") + ylab("CD8 Effector CFS") + 
  theme_linedraw() + theme(plot.title = element_text(size = 58, face = "bold")) + 
  theme(axis.text.x = element_text(hjust=1,size = 42),
        axis.text.y = element_text(hjust=1,size = 42),
        axis.title.x = element_text(size = 52,face = "bold"),
        axis.title.y = element_text(size = 52,face = "bold"),
        legend.title = element_text(size=28,face = "bold"), #change legend title font size
        legend.text = element_text(size=28,face = "bold")) + theme(strip.text.x = element_text(size = 52,face = 'bold')) + 
  theme(strip.background =element_rect(fill="white"))+
  theme(strip.text = element_text(colour = 'black')) +xlim(0,0.8) + ylim(0,0.8)
dev.off()


jpeg("66yrold_CD8_memory2_vs_effector2.jpeg",width=75,height=25,units="cm",res=300)
ggplot(data = cd8_df, aes(x=memoryscore2,y = effectorscore2))+ 
  geom_point(colour = c("#f1bc1a"),size = 4)+  geom_smooth(method = "lm",colour = "#cd6116",fill = "#cd6116",size = 4) + 
  stat_cor(method = "pearson",cor.coef.name = "rho",size = 16,
            aes(label =paste0(..r.label..,' (', cut(..p..,
                                           breaks = c(-Inf,1e-6, 1e-4, 1e-2, Inf),
                                           labels = c("'***'", "'**'", "'*'", "'ns'")),')')) )+
  facet_wrap( ~ days_post_intubation,nrow = 1) + 
  scale_color_manual(values = c("#f1bc1a"), name = "Days Post Intubation") + xlab("CD8 Memory CFS") + ylab("CD8 Effector CFS") + 
  theme_linedraw() + theme(plot.title = element_text(size = 58, face = "bold")) + 
  theme(axis.text.x = element_text(hjust=1,size = 42),
        axis.text.y = element_text(hjust=1,size = 42),
        axis.title.x = element_text(size = 52,face = "bold"),
        axis.title.y = element_text(size = 52,face = "bold"),
        legend.title = element_text(size=28,face = "bold"), #change legend title font size
        legend.text = element_text(size=28,face = "bold")) + theme(strip.text.x = element_text(size = 52,face = 'bold')) + 
  theme(strip.background =element_rect(fill="white"))+
  theme(strip.text = element_text(colour = 'black')) + ylim(0,0.8)
dev.off()


```

```{r CD4 from 66-year-old Patient Fig 5a-b, Supplementary Fig 6a-b}

ret_effectorcd4 = readRDS("NEW_effectorcd4_BLightning_results_CFS1_cutoff3.rds")

known.effector.upregulated.markers =  c("IFNG","TBX21","GATA3","CXCR3","RORC","TNF")
known.effector.downregulated.markers = c()


effectorscore0 = getscore(cscore,known.effector.upregulated.markers,known.effector.downregulated.markers,
                          covid_66_cd4@assays$RNA@counts[c(known.effector.upregulated.markers,known.effector.downregulated.markers),])

effectorscore1 = getscore(cscore,ret_effectorcd4[[2]],ret_effectorcd4[[3]],
                          covid_66_cd4@assays$RNA@counts[c(ret_effectorcd4[[2]],ret_effectorcd4[[3]]),])

effectorscore2 = getscore(cscore,c(known.effector.upregulated.markers,ret_effectorcd4[[2]]),c(known.effector.downregulated.markers,ret_effectorcd4[[3]]),
                          covid_66_cd4@assays$RNA@counts[c(known.effector.upregulated.markers,ret_effectorcd4[[2]],known.effector.downregulated.markers,ret_effectorcd4[[3]]),])

cd4_df = as.data.frame(effectorscore0)
cd4_df$effectorscore1 = effectorscore1
cd4_df$effectorscore2 = effectorscore2


cd4_metadata = covid_66_cd4@meta.data
cd4_metadata = cd4_metadata[rownames(cd4_df),]
cd4_df$days_post_intubation=cd4_metadata$days_post_intubation
cd4_df$days_post_intubation[cd4_df$days_post_intubation %in% c("3","4")] = "3,4"
cd4_df$days_post_intubation = paste("Day",cd4_df$days_post_intubation)
ret_memorycd4 = readRDS("memorycd4_BLightning_results_CFS1_cutoff3.rds")
ret_memorycd4[[6]] = ret_memorycd4[[6]][-grep("RP",ret_memorycd4[[2]],fixed=TRUE)]
ret_memorycd4[[2]] = ret_memorycd4[[2]][-grep("RP",ret_memorycd4[[2]],fixed=TRUE)]
ret_memorycd4[[6]] = ret_memorycd4[[6]][-grep("MT",ret_memorycd4[[2]],fixed=TRUE)]
ret_memorycd4[[2]] = ret_memorycd4[[2]][-grep("MT",ret_memorycd4[[2]],fixed=TRUE)]

known.memory.upregulated.markers = c("PTPRC","SELL","CCR7","CD27","CD44")

known.memory.downregulated.markers = c()
memoryscore0 = getscore(cscore,known.memory.upregulated.markers,known.memory.downregulated.markers,
                        covid_66_cd4@assays$RNA@counts[c(known.memory.upregulated.markers,known.memory.downregulated.markers),])

memoryscore1 = getscore(cscore,ret_memorycd4[[2]],ret_memorycd4[[3]],
                        covid_66_cd4@assays$RNA@counts[c(ret_memorycd4[[2]],ret_memorycd4[[3]]),])

memoryscore2 = getscore(cscore,c(known.memory.upregulated.markers,ret_memorycd4[[2]]),c(known.memory.downregulated.markers,ret_memorycd4[[3]]),
                        covid_66_cd4@assays$RNA@counts[c(known.memory.upregulated.markers,ret_memorycd4[[2]],known.memory.downregulated.markers,ret_memorycd4[[3]]),])

cd4_df$memoryscore0 = memoryscore0
cd4_df$memoryscore1 = memoryscore1
cd4_df$memoryscore2 = memoryscore2

cd4_dummy <- cd4_df %>%
  group_by(days_post_intubation) %>%
  summarize(effectorscore0.mean = median(effectorscore0),effectorscore1.mean = median(effectorscore1),effectorscore2.mean = median(effectorscore2))

jpeg("66yrold_CD4_effectorscore0_bydays.jpeg",width=75,height=25,units="cm",res=300)
ggplot(data = cd4_df, aes(x=effectorscore0))  +labs(x = "",y = "Density") +
  geom_density(lwd = 5, linetype = 1,aes(x=effectorscore0),colour = c("#3290B5"))+ 
  facet_wrap( ~ days_post_intubation,nrow = 1) + 
  geom_vline(data=cd4_dummy, aes(xintercept=effectorscore0.mean),colour = c("#3290B5"),lwd = 5, linetype = 1) +
  theme_linedraw() + ggtitle("CD4 Effector CFS") + theme(plot.title = element_text(size = 58, face = "bold")) + 
  theme(axis.text.x = element_text(hjust=1,size = 36,face = "bold"),
        axis.text.y = element_text(hjust=1,size = 42,face = "bold"),
        axis.title.y = element_text(size = 46,face = "bold"),
        legend.title = element_text(size=46,face = "bold"), #change legend title font size
        legend.text = element_text(size=46,face = "bold")) + theme(strip.text.x = element_text(size = 52,face = 'bold')) +
  theme(strip.background =element_rect(fill="white"))+
  theme(strip.text = element_text(colour = 'black')) + xlim(0,0.8)
dev.off()


jpeg("66yrold_CD4_effectorscore2_bydays.jpeg",width=75,height=25,units="cm",res=300)
ggplot(data = cd4_df, aes(x=effectorscore2))  +labs(x = "",y = "Density") +
  geom_density(lwd = 5, linetype = 1,aes(x=effectorscore2),colour = c("#3290B5"))+ 
  facet_wrap( ~ days_post_intubation,nrow = 1) + 
  geom_vline(data=cd4_dummy, aes(xintercept=effectorscore2.mean),colour = c("#3290B5"),lwd = 5, linetype = 1) +
  theme_linedraw() + ggtitle("CD4 Effector CFS") + theme(plot.title = element_text(size = 58, face = "bold")) + 
  theme(axis.text.x = element_text(hjust=1,size = 36,face = "bold"),
        axis.text.y = element_text(hjust=1,size = 42,face = "bold"),
        axis.title.y = element_text(size = 46,face = "bold"),
        legend.title = element_text(size=46,face = "bold"), #change legend title font size
        legend.text = element_text(size=46,face = "bold")) + theme(strip.text.x = element_text(size = 52,face = 'bold')) + 
  theme(strip.background =element_rect(fill="white"))+
  theme(strip.text = element_text(colour = 'black')) + ylim(0,4)+ xlim(0,0.9)
dev.off()


cd4_dummy <- cd4_df %>%
  group_by(days_post_intubation) %>%
  summarize(memoryscore0.mean = median(memoryscore0),memoryscore1.mean = median(memoryscore1),memoryscore2.mean = median(memoryscore2))

jpeg("66yrold_CD4_memoryscore0_bydays.jpeg",width=75,height=25,units="cm",res=300)
ggplot(data = cd4_df, aes(x = memoryscore0))  +labs(x = "",y = "Density") +
  geom_density(lwd = 5, linetype = 1,aes(x = memoryscore0),colour = c("#03608C"))+ 
  facet_wrap( ~ days_post_intubation,nrow = 1) + 
  geom_vline(data = cd4_dummy, aes(xintercept = memoryscore0.mean),colour = c("#03608C"),lwd = 5, linetype = 1) +
  theme_linedraw() + ggtitle("CD4 Memory CFS") + theme(plot.title = element_text(size = 58, face = "bold")) + 
  theme(axis.text.x = element_text(hjust=1,size = 36,face = "bold"),
        axis.text.y = element_text(hjust=1,size = 42,face = "bold"),
        axis.title.y = element_text(size = 46,face = "bold"),
        legend.title = element_text(size=46,face = "bold"), #change legend title font size
        legend.text = element_text(size=46,face = "bold")) + theme(strip.text.x = element_text(size = 52,face = 'bold')) +
  theme(strip.background =element_rect(fill="white"))+
  theme(strip.text = element_text(colour = 'black')) + ylim(0,5) + xlim(0,0.8)
dev.off()


jpeg("66yrold_CD4_memoryscore2_bydays.jpeg",width=75,height=25,units="cm",res=300)
ggplot(data = cd4_df, aes(x=memoryscore2))  +labs(x = "",y = "Density") +
  geom_density(lwd = 5, linetype = 1,aes(x=memoryscore2),colour = c("#03608C"))+ 
  facet_wrap( ~ days_post_intubation,nrow = 1) + 
  geom_vline(data=cd4_dummy, aes(xintercept=memoryscore2.mean),colour = c("#03608C"),lwd = 5, linetype = 1) +
  theme_linedraw() + ggtitle("CD4 Memory CFS") + theme(plot.title = element_text(size = 58, face = "bold")) + 
  theme(axis.text.x = element_text(hjust=1,size = 36,face = "bold"),
        axis.text.y = element_text(hjust=1,size = 42,face = "bold"),
        axis.title.y = element_text(size = 46,face = "bold"),
        legend.title = element_text(size=46,face = "bold"), #change legend title font size
        legend.text = element_text(size=46,face = "bold")) + theme(strip.text.x = element_text(size = 52,face = 'bold')) + 
  theme(strip.background =element_rect(fill="white"))+
  theme(strip.text = element_text(colour = 'black'))  + xlim(0,0.9)
dev.off()
```
```{r CD4 from 66-year-old Patient Fig 5c-d} 

library(ggpubr)
jpeg("66yrold_CD4_memory0_vs_effector0.jpeg",width=75,height=25,units="cm",res=300)
ggplot(data = cd4_df, aes(x=memoryscore0,y = effectorscore0))+ 
  geom_point(colour = c("#f1bc1a"),size = 4)+  geom_smooth(method = "lm",colour = "#cd6116",fill = "#cd6116",size = 4) + 
  stat_cor(method = "pearson",cor.coef.name = "rho",size = 16,
            aes(label =paste0(..r.label..,' (', cut(..p..,
                                           breaks = c(-Inf,1e-6, 1e-4, 1e-2, Inf),
                                           labels = c("'***'", "'**'", "'*'", "'ns'")),')')) )+
  facet_wrap( ~ days_post_intubation,nrow = 1) + 
  scale_color_manual(values = c("#f1bc1a"), name = "Days Post Intubation") + xlab("CD4 Memory CFS") + ylab("CD4 Effector CFS") + 
  theme_linedraw() + theme(plot.title = element_text(size = 58, face = "bold")) + 
  theme(axis.text.x = element_text(hjust=1,size = 42),
        axis.text.y = element_text(hjust=1,size = 42),
        axis.title.x = element_text(size = 52,face = "bold"),
        axis.title.y = element_text(size = 52,face = "bold"),
        legend.title = element_text(size=28,face = "bold"), #change legend title font size
        legend.text = element_text(size=28,face = "bold")) + theme(strip.text.x = element_text(size = 52,face = 'bold')) + 
  theme(strip.background =element_rect(fill="white"))+
  theme(strip.text = element_text(colour = 'black')) + xlim(0,0.8) + ylim(0,0.8)
dev.off()

jpeg("66yrold_CD4_memory2_vs_effector2.jpeg",width=75,height=25,units="cm",res=300)
ggplot(data = cd4_df, aes(x=memoryscore2,y = effectorscore2))+ 
  geom_point(colour = c("#f1bc1a"),size = 4)+  geom_smooth(method = "lm",colour = "#cd6116",fill = "#cd6116",size = 4) + 
  stat_cor(method = "pearson",cor.coef.name = "rho",size = 16,
            aes(label =paste0(..r.label..,' (', cut(..p..,
                                           breaks = c(-Inf,1e-6, 1e-4, 1e-2, Inf),
                                           labels = c("'***'", "'**'", "'*'", "'ns'")),')')) )+
  facet_wrap( ~ days_post_intubation,nrow = 1) + 
  scale_color_manual(values = c("#f1bc1a"), name = "Days Post Intubation") + xlab("CD4 Memory CFS") + ylab("CD4 Effector CFS") + 
  theme_linedraw() + theme(plot.title = element_text(size = 58, face = "bold")) + 
  theme(axis.text.x = element_text(hjust=1,size = 42),
        axis.text.y = element_text(hjust=1,size = 42),
        axis.title.x = element_text(size = 52,face = "bold"),
        axis.title.y = element_text(size = 52,face = "bold"),
        legend.title = element_text(size=28,face = "bold"), #change legend title font size
        legend.text = element_text(size=28,face = "bold")) + theme(strip.text.x = element_text(size = 52,face = 'bold')) + 
  theme(strip.background =element_rect(fill="white"))+
  theme(strip.text = element_text(colour = 'black'))  + xlim(0,0.8) + ylim(0,0.8)
dev.off()
```

#49-year-old Patient

```{r loading and CD8 from 49-year-old Patient Supplementary Fig 4e-f, 6g-h}
covid_49_cd8 = readRDS("covid_49_cd8_so.rds")
covid_49_cd4 = readRDS("covid_49_cd4_so.rds")

ret_effectorcd8 = readRDS("NEW_effectorcd8_BLightning_results_CFS1_cutoff3.rds")#3
cscore = 'CFS1'

known.effector.upregulated.markers = c("GZMB","PRF1","IFNG","TNF","IL2RA","TBX21")
known.effector.downregulated.markers = c("CCR7","SELL")

effectorscore0 = getscore(cscore,known.effector.upregulated.markers,known.effector.downregulated.markers,
                        covid_49_cd8@assays$RNA@counts[c(known.effector.upregulated.markers,known.effector.downregulated.markers),])

effectorscore1 = getscore(cscore,ret_effectorcd8[[2]],ret_effectorcd8[[3]],
                        covid_49_cd8@assays$RNA@counts[c(ret_effectorcd8[[2]],ret_effectorcd8[[3]]),])

effectorscore2 = getscore(cscore,c(known.effector.upregulated.markers,ret_effectorcd8[[2]]),c(known.effector.downregulated.markers,ret_effectorcd8[[3]]),
                        covid_49_cd8@assays$RNA@counts[c(known.effector.upregulated.markers,ret_effectorcd8[[2]],known.effector.downregulated.markers,ret_effectorcd8[[3]]),])

cd8_df = as.data.frame(effectorscore0)
cd8_df$effectorscore1 = effectorscore1
cd8_df$effectorscore2 = effectorscore2


cd8_metadata = covid_49_cd8@meta.data
cd8_metadata = cd8_metadata[rownames(cd8_df),]
cd8_df$days_post_intubation=cd8_metadata$days_post_intubation

ret_memorycd8 = readRDS("NEW_memorycd8_BLightning_results_CFS1_cutoff4.rds")#4

known.memory.upregulated.markers = c("CD27","CD28","PTPRC","SELL","CCR7","BCL2","IL7R","CXCR3","EOMES","ID3")
known.memory.upregulated.markers = known.memory.upregulated.markers[known.memory.upregulated.markers %in% rownames(covid_49_cd8)]
known.memory.downregulated.markers = c()

memoryscore0 = getscore(cscore,known.memory.upregulated.markers,known.memory.downregulated.markers,
                        covid_49_cd8@assays$RNA@counts[c(known.memory.upregulated.markers,known.memory.downregulated.markers),])

memoryscore1 = getscore(cscore,ret_memorycd8[[2]],ret_memorycd8[[3]],
                        covid_49_cd8@assays$RNA@counts[c(ret_memorycd8[[2]],ret_memorycd8[[3]]),])

memoryscore2 = getscore(cscore,c(known.memory.upregulated.markers,ret_memorycd8[[2]]),c(known.memory.downregulated.markers,ret_memorycd8[[3]]),
                        covid_49_cd8@assays$RNA@counts[c(known.memory.upregulated.markers,ret_memorycd8[[2]],known.memory.downregulated.markers,ret_memorycd8[[3]]),])

cd8_df$memoryscore0 = memoryscore0
cd8_df$memoryscore1 = memoryscore1
cd8_df$memoryscore2 = memoryscore2

cd8_df$days_post_intubation = paste("Day",cd8_df$days_post_intubation)
cd8_dummy <- cd8_df %>%
  group_by(days_post_intubation) %>%
  summarize(effectorscore0.mean = median(effectorscore0),effectorscore1.mean = median(effectorscore1),effectorscore2.mean = median(effectorscore2))

jpeg("49yrold_CD8_effectorscore0_bydays.jpeg",width=75,height=25,units="cm",res=300)
ggplot(data = cd8_df, aes(x=effectorscore0))  +labs(x = "",y = "Density") +
  geom_density(lwd = 5, linetype = 1,aes(x=effectorscore0),colour = c("#3290B5"))+ 
  facet_wrap( ~ days_post_intubation,nrow = 1) + 
  geom_vline(data=cd8_dummy, aes(xintercept=effectorscore0.mean),colour = c("#3290B5"),lwd = 5, linetype = 1) +
  theme_linedraw() + ggtitle("CD8 Effector CFS") + theme(plot.title = element_text(size = 58, face = "bold")) + 
  theme(axis.text.x = element_text(hjust=1,size = 36,face = "bold"),
        axis.text.y = element_text(hjust=1,size = 42,face = "bold"),
        axis.title.y = element_text(size = 46,face = "bold"),
        legend.title = element_text(size=46,face = "bold"), #change legend title font size
        legend.text = element_text(size=46,face = "bold")) + theme(strip.text.x = element_text(size = 52,face = 'bold')) +
  theme(strip.background =element_rect(fill="white"))+
  theme(strip.text = element_text(colour = 'black')) + ylim(0,6)+ xlim(0,0.65)
dev.off()



jpeg("49yrold_CD8_effectorscore2_bydays.jpeg",width=75,height=25,units="cm",res=300)
ggplot(data = cd8_df, aes(x=effectorscore2))  +labs(x = "",y = "Density") +
  geom_density(lwd = 5, linetype = 1,aes(x=effectorscore2),colour = c("#3290B5"))+ 
  facet_wrap( ~ days_post_intubation,nrow = 1) + 
  geom_vline(data=cd8_dummy, aes(xintercept=effectorscore2.mean),colour = c("#3290B5"),lwd = 5, linetype = 1) +
  theme_linedraw() + ggtitle("CD8 Effector CFS") + theme(plot.title = element_text(size = 58, face = "bold")) + 
  theme(axis.text.x = element_text(hjust=1,size = 36,face = "bold"),
        axis.text.y = element_text(hjust=1,size = 42,face = "bold"),
        axis.title.y = element_text(size = 46,face = "bold"),
        legend.title = element_text(size=46,face = "bold"), #change legend title font size
        legend.text = element_text(size=46,face = "bold")) + theme(strip.text.x = element_text(size = 52,face = 'bold')) + 
  theme(strip.background =element_rect(fill="white"))+
  theme(strip.text = element_text(colour = 'black')) + ylim(0,5) + xlim(0,0.65)
dev.off()


cd8_dummy <- cd8_df %>%
  group_by(days_post_intubation) %>%
  summarize(memoryscore0.mean = median(memoryscore0),memoryscore1.mean = median(memoryscore1),memoryscore2.mean = median(memoryscore2))

jpeg("49yrold_CD8_memoryscore0_bydays.jpeg",width=75,height=25,units="cm",res=300)
ggplot(data = cd8_df, aes(x = memoryscore0))  +labs(x = "",y = "Density") +
  geom_density(lwd = 5, linetype = 1,aes(x = memoryscore0),colour = c("#03608C"))+ 
  facet_wrap( ~ days_post_intubation,nrow = 1) + 
  geom_vline(data = cd8_dummy, aes(xintercept = memoryscore0.mean),colour = c("#03608C"),lwd = 5, linetype = 1) +
  theme_linedraw() + ggtitle("CD8 Memory CFS") + theme(plot.title = element_text(size = 58, face = "bold")) + 
  theme(axis.text.x = element_text(hjust=1,size = 36,face = "bold"),
        axis.text.y = element_text(hjust=1,size = 42,face = "bold"),
        axis.title.y = element_text(size = 46,face = "bold"),
        legend.title = element_text(size=46,face = "bold"), #change legend title font size
        legend.text = element_text(size=46,face = "bold")) + theme(strip.text.x = element_text(size = 52,face = 'bold')) +
  theme(strip.background =element_rect(fill="white"))+
  theme(strip.text = element_text(colour = 'black')) +ylim(0,6) + xlim(0,0.65)
dev.off()


jpeg("49yrold_CD8_memoryscore2_bydays.jpeg",width=75,height=25,units="cm",res=300)
ggplot(data = cd8_df, aes(x=memoryscore2))  +labs(x = "",y = "Density") +
  geom_density(lwd = 5, linetype = 1,aes(x=memoryscore2),colour = c("#03608C"))+ 
  facet_wrap( ~ days_post_intubation,nrow = 1) + 
  geom_vline(data=cd8_dummy, aes(xintercept=memoryscore2.mean),colour = c("#03608C"),lwd = 5, linetype = 1) +
  theme_linedraw() + ggtitle("CD8 Memory CFS") + theme(plot.title = element_text(size = 58, face = "bold")) + 
  theme(axis.text.x = element_text(hjust=1,size = 36,face = "bold"),
        axis.text.y = element_text(hjust=1,size = 42,face = "bold"),
        axis.title.y = element_text(size = 46,face = "bold"),
        legend.title = element_text(size=46,face = "bold"), #change legend title font size
        legend.text = element_text(size=46,face = "bold")) + theme(strip.text.x = element_text(size = 52,face = 'bold')) + 
  theme(strip.background =element_rect(fill="white"))+
  theme(strip.text = element_text(colour = 'black')) + ylim(0,5)
dev.off()

```
```{r CD8 from 49-year-old Patient Supplementary Fig 4g-h}

library(ggpubr)
jpeg("49yrold_CD8_memory0_vs_effector0.jpeg",width=75,height=25,units="cm",res=300)
ggplot(data = cd8_df, aes(x=memoryscore0,y = effectorscore0))+ 
  geom_point(colour = c("#f1bc1a"),size = 4)+  geom_smooth(method = "lm",colour = "#cd6116",fill = "#cd6116",size = 4) + 
  stat_cor(method = "pearson",cor.coef.name = "rho",size = 16,
            aes(label =paste0(..r.label..,' (', cut(..p..,
                                           breaks = c(-Inf,1e-6, 1e-4, 1e-2, Inf),
                                           labels = c("'***'", "'**'", "'*'", "'ns'")),')')) )+
  facet_wrap( ~ days_post_intubation,nrow = 1) + 
  scale_color_manual(values = c("#f1bc1a"), name = "Days Post Intubation") + xlab("CD8 Memory CFS") + ylab("CD8 Effector CFS") + 
  theme_linedraw() + theme(plot.title = element_text(size = 58, face = "bold")) + 
  theme(axis.text.x = element_text(hjust=1,size = 42),
        axis.text.y = element_text(hjust=1,size = 42),
        axis.title.x = element_text(size = 52,face = "bold"),
        axis.title.y = element_text(size = 52,face = "bold"),
        legend.title = element_text(size=28,face = "bold"), #change legend title font size
        legend.text = element_text(size=28,face = "bold")) + theme(strip.text.x = element_text(size = 52,face = 'bold')) + 
  theme(strip.background =element_rect(fill="white"))+
  theme(strip.text = element_text(colour = 'black')) + xlim(0,0.65)
dev.off()



jpeg("49yrold_CD8_memory2_vs_effector2.jpeg",width=75,height=25,units="cm",res=300)
ggplot(data = cd8_df, aes(x=memoryscore2,y = effectorscore2))+ 
  geom_point(colour = c("#f1bc1a"),size = 4)+  geom_smooth(method = "lm",colour = "#cd6116",fill = "#cd6116",size = 4) + 
  stat_cor(method = "pearson",cor.coef.name = "rho",size = 16,
            aes(label =paste0(..r.label..,' (', cut(..p..,
                                           breaks = c(-Inf,1e-6, 1e-4, 1e-2, Inf),
                                           labels = c("'***'", "'**'", "'*'", "'ns'")),')')) )+
  facet_wrap( ~ days_post_intubation,nrow = 1) + 
  scale_color_manual(values = c("#f1bc1a"), name = "Days Post Intubation") + xlab("CD8 Memory CFS") + ylab("CD8 Effector CFS") + 
  theme_linedraw() + theme(plot.title = element_text(size = 58, face = "bold")) + 
  theme(axis.text.x = element_text(hjust=1,size = 42),
        axis.text.y = element_text(hjust=1,size = 42),
        axis.title.x = element_text(size = 52,face = "bold"),
        axis.title.y = element_text(size = 52,face = "bold"),
        legend.title = element_text(size=28,face = "bold"), #change legend title font size
        legend.text = element_text(size=28,face = "bold")) + theme(strip.text.x = element_text(size = 52,face = 'bold')) + 
  theme(strip.background =element_rect(fill="white"))+
  theme(strip.text = element_text(colour = 'black')) 
dev.off()


```

```{r CD4 from 49-year-old Patient Fig 5e-f, Supplementary Fig 6e-f}

ret_effectorcd4 = readRDS("data/NEW_effectorcd4_BLightning_results_CFS1_cutoff3.rds")

known.effector.upregulated.markers =  c("IFNG","TBX21","GATA3","CXCR3","RORC","TNF")
known.effector.downregulated.markers = c()


effectorscore0 = getscore(cscore,known.effector.upregulated.markers,known.effector.downregulated.markers,
                        covid_49_cd4@assays$RNA@counts[c(known.effector.upregulated.markers,known.effector.downregulated.markers),])

effectorscore1 = getscore(cscore,ret_effectorcd4[[2]],ret_effectorcd4[[3]],
                        covid_49_cd4@assays$RNA@counts[c(ret_effectorcd4[[2]],ret_effectorcd4[[3]]),])

effectorscore2 = getscore(cscore,c(known.effector.upregulated.markers,ret_effectorcd4[[2]]),c(known.effector.downregulated.markers,ret_effectorcd4[[3]]),
                        covid_49_cd4@assays$RNA@counts[c(known.effector.upregulated.markers,ret_effectorcd4[[2]],known.effector.downregulated.markers,ret_effectorcd4[[3]]),])

cd4_df = as.data.frame(effectorscore0)
cd4_df$effectorscore1 = effectorscore1
cd4_df$effectorscore2 = effectorscore2


cd4_metadata = covid_49_cd4@meta.data
cd4_metadata = cd4_metadata[rownames(cd4_df),]
cd4_df$days_post_intubation=cd4_metadata$days_post_intubation
cd4_df$days_post_intubation = paste("Day",cd4_df$days_post_intubation)

ret_memorycd4 = readRDS("memorycd4_BLightning_results_CFS1_cutoff3.rds")

ret_memorycd4[[4]] = ret_memorycd4[[4]][-grep("RP",ret_memorycd4[[2]],fixed=TRUE)]
ret_memorycd4[[2]] = ret_memorycd4[[2]][-grep("RP",ret_memorycd4[[2]],fixed=TRUE)]
ret_memorycd4[[4]] = ret_memorycd4[[4]][-grep("MT",ret_memorycd4[[2]],fixed=TRUE)]
ret_memorycd4[[2]] = ret_memorycd4[[2]][-grep("MT",ret_memorycd4[[2]],fixed=TRUE)]

known.memory.upregulated.markers = c("PTPRC","SELL","CCR7","CD27","CD44")

known.memory.downregulated.markers = c()
memoryscore0 = getscore(cscore,known.memory.upregulated.markers,known.memory.downregulated.markers,
                        covid_49_cd4@assays$RNA@counts[c(known.memory.upregulated.markers,known.memory.downregulated.markers),])

memoryscore1 = getscore(cscore,ret_memorycd4[[2]],ret_memorycd4[[3]],
                        covid_49_cd4@assays$RNA@counts[c(ret_memorycd4[[2]],ret_memorycd4[[3]]),])

memoryscore2 = getscore(cscore,c(known.memory.upregulated.markers,ret_memorycd4[[2]]),c(known.memory.downregulated.markers,ret_memorycd4[[3]]),
                        covid_49_cd4@assays$RNA@counts[c(known.memory.upregulated.markers,ret_memorycd4[[2]],known.memory.downregulated.markers,ret_memorycd4[[3]]),])

cd4_df$memoryscore0 = memoryscore0
cd4_df$memoryscore1 = memoryscore1
cd4_df$memoryscore2 = memoryscore2

cd4_dummy <- cd4_df %>%
  group_by(days_post_intubation) %>%
  summarize(effectorscore0.mean = median(effectorscore0),effectorscore1.mean = median(effectorscore1),effectorscore2.mean = median(effectorscore2))

jpeg("49yrold_CD4_effectorscore0_bydays.jpeg",width=75,height=25,units="cm",res=300)
ggplot(data = cd4_df, aes(x=effectorscore0))  +labs(x = "",y = "Density") +
  geom_density(lwd = 5, linetype = 1,aes(x=effectorscore0),colour = c("#3290B5"))+ 
  facet_wrap( ~ days_post_intubation,nrow = 1) + 
  geom_vline(data=cd4_dummy, aes(xintercept=effectorscore0.mean),colour = c("#3290B5"),lwd = 5, linetype = 1) +
  theme_linedraw() + ggtitle("CD4 Effector CFS") + theme(plot.title = element_text(size = 58, face = "bold")) + 
  theme(axis.text.x = element_text(hjust=1,size = 36,face = "bold"),
        axis.text.y = element_text(hjust=1,size = 42,face = "bold"),
        axis.title.y = element_text(size = 46,face = "bold"),
        legend.title = element_text(size=46,face = "bold"), #change legend title font size
        legend.text = element_text(size=46,face = "bold")) + theme(strip.text.x = element_text(size = 52,face = 'bold')) +
  theme(strip.background =element_rect(fill="white"))+
  theme(strip.text = element_text(colour = 'black')) + ylim(0,12.5) + xlim(0,0.65)
dev.off()


jpeg("49yrold_CD4_effectorscore2_bydays.jpeg",width=75,height=25,units="cm",res=300)
ggplot(data = cd4_df, aes(x=effectorscore2))  +labs(x = "",y = "Density") +
  geom_density(lwd = 5, linetype = 1,aes(x=effectorscore2),colour = c("#3290B5"))+ 
  facet_wrap( ~ days_post_intubation,nrow = 1) + 
  geom_vline(data=cd4_dummy, aes(xintercept=effectorscore2.mean),colour = c("#3290B5"),lwd = 5, linetype = 1) +
  theme_linedraw() + ggtitle("CD4 Effector CFS") + theme(plot.title = element_text(size = 58, face = "bold")) + 
  theme(axis.text.x = element_text(hjust=1,size = 36,face = "bold"),
        axis.text.y = element_text(hjust=1,size = 42,face = "bold"),
        axis.title.y = element_text(size = 46,face = "bold"),
        legend.title = element_text(size=46,face = "bold"), #change legend title font size
        legend.text = element_text(size=46,face = "bold")) + theme(strip.text.x = element_text(size = 52,face = 'bold')) + 
  theme(strip.background =element_rect(fill="white"))+
  theme(strip.text = element_text(colour = 'black')) + ylim(0,9)
dev.off()


cd4_dummy <- cd4_df %>%
  group_by(days_post_intubation) %>%
  summarize(memoryscore0.mean = median(memoryscore0),memoryscore1.mean = median(memoryscore1),memoryscore2.mean = median(memoryscore2))

jpeg("49yrold_CD4_memoryscore0_bydays.jpeg",width=75,height=25,units="cm",res=300)
ggplot(data = cd4_df, aes(x = memoryscore0))  +labs(x = "",y = "Density") +
  geom_density(lwd = 5, linetype = 1,aes(x = memoryscore0),colour = c("#03608C"))+ 
  facet_wrap( ~ days_post_intubation,nrow = 1) + 
  geom_vline(data = cd4_dummy, aes(xintercept = memoryscore0.mean),colour = c("#03608C"),lwd = 5, linetype = 1) +
  theme_linedraw() + ggtitle("CD4 Memory CFS") + theme(plot.title = element_text(size = 58, face = "bold")) + 
  theme(axis.text.x = element_text(hjust=1,size = 36,face = "bold"),
        axis.text.y = element_text(hjust=1,size = 42,face = "bold"),
        axis.title.y = element_text(size = 46,face = "bold"),
        legend.title = element_text(size=46,face = "bold"), #change legend title font size
        legend.text = element_text(size=46,face = "bold")) + theme(strip.text.x = element_text(size = 52,face = 'bold')) +
  theme(strip.background =element_rect(fill="white"))+
  theme(strip.text = element_text(colour = 'black')) + ylim(0,12.5) + xlim(0,0.65)
dev.off()




jpeg("49yrold_CD4_memoryscore2_bydays.jpeg",width=75,height=25,units="cm",res=300)
ggplot(data = cd4_df, aes(x=memoryscore2))  +labs(x = "",y = "Density") +
  geom_density(lwd = 5, linetype = 1,aes(x=memoryscore2),colour = c("#03608C"))+ 
  facet_wrap( ~ days_post_intubation,nrow = 1) + 
  geom_vline(data=cd4_dummy, aes(xintercept=memoryscore2.mean),colour = c("#03608C"),lwd = 5, linetype = 1) +
  theme_linedraw() + ggtitle("CD4 Memory CFS") + theme(plot.title = element_text(size = 58, face = "bold")) + 
  theme(axis.text.x = element_text(hjust=1,size = 36,face = "bold"),
        axis.text.y = element_text(hjust=1,size = 42,face = "bold"),
        axis.title.y = element_text(size = 46,face = "bold"),
        legend.title = element_text(size=46,face = "bold"), #change legend title font size
        legend.text = element_text(size=46,face = "bold")) + theme(strip.text.x = element_text(size = 52,face = 'bold')) + 
  theme(strip.background =element_rect(fill="white"))+
  theme(strip.text = element_text(colour = 'black')) + ylim(0,9) + xlim(0,0.8)
dev.off()
```
```{r CD4 from 49-year-old Patient Fig 5g-h}
#library(ggpmisc)
library(ggpubr)
jpeg("49yrold_CD4_memory0_vs_effector0.jpeg",width=75,height=25,units="cm",res=300)
ggplot(data = cd4_df, aes(x=memoryscore0,y = effectorscore0))+ 
  geom_point(colour = c("#f1bc1a"),size = 4)+  geom_smooth(method = "lm",colour = "#cd6116",fill = "#cd6116",size = 4) + 
  stat_cor(method = "pearson",cor.coef.name = "rho",size = 16,
            aes(label =paste0(..r.label..,' (', cut(..p..,
                                           breaks = c(-Inf,1e-6, 1e-4, 1e-2, Inf),
                                           labels = c("'***'", "'**'", "'*'", "'ns'")),')')) )+
  facet_wrap( ~ days_post_intubation,nrow = 1) + 
  scale_color_manual(values = c("#f1bc1a"), name = "Days Post Intubation") + xlab("CD4 Memory CFS") + ylab("CD4 Effector CFS") + 
  theme_linedraw() + theme(plot.title = element_text(size = 58, face = "bold")) + 
  theme(axis.text.x = element_text(hjust=1,size = 42),
        axis.text.y = element_text(hjust=1,size = 42),
        axis.title.x = element_text(size = 52,face = "bold"),
        axis.title.y = element_text(size = 52,face = "bold"),
        legend.title = element_text(size=28,face = "bold"), #change legend title font size
        legend.text = element_text(size=28,face = "bold")) + theme(strip.text.x = element_text(size = 52,face = 'bold')) + 
  theme(strip.background =element_rect(fill="white"))+
  theme(strip.text = element_text(colour = 'black')) +xlim(0,0.6) + ylim(0,0.65)
dev.off()


jpeg("49yrold_CD4_memory2_vs_effector2.jpeg",width=75,height=25,units="cm",res=300)
ggplot(data = cd4_df, aes(x=memoryscore2,y = effectorscore2))+ 
  geom_point(colour = c("#f1bc1a"),size = 4)+  geom_smooth(method = "lm",colour = "#cd6116",fill = "#cd6116",size = 4) + 
  stat_cor(method = "pearson",cor.coef.name = "rho",size = 16,
            aes(label =paste0(..r.label..,' (', cut(..p..,
                                           breaks = c(-Inf,1e-6, 1e-4, 1e-2, Inf),
                                           labels = c("'***'", "'**'", "'*'", "'ns'")),')')) )+
  facet_wrap( ~ days_post_intubation,nrow = 1) + 
  scale_color_manual(values = c("#f1bc1a"), name = "Days Post Intubation") + xlab("CD4 Memory CFS") + ylab("CD4 Effector CFS") + 
  theme_linedraw() + theme(plot.title = element_text(size = 58, face = "bold")) + 
  theme(axis.text.x = element_text(hjust=1,size = 42),
        axis.text.y = element_text(hjust=1,size = 42),
        axis.title.x = element_text(size = 52,face = "bold"),
        axis.title.y = element_text(size = 52,face = "bold"),
        legend.title = element_text(size=28,face = "bold"), #change legend title font size
        legend.text = element_text(size=28,face = "bold")) + theme(strip.text.x = element_text(size = 52,face = 'bold')) + 
  theme(strip.background =element_rect(fill="white"))+
  theme(strip.text = element_text(colour = 'black')) +xlim(0,0.6) + ylim(0,0.65)
dev.off()
```